service: gmail-poller

frameworkVersion: '3'

provider:
  name: aws
  runtime: nodejs20.x
  region: us-east-1
  stage: ${opt:stage, 'dev'}
  timeout: 900  # 15 minutes - maximum Lambda timeout for continuous polling
  memorySize: 512  # Increased memory for better performance
  environment:
    # Gmail OAuth2 credentials - set these in AWS Lambda console or via serverless
    GMAIL_CLIENT_ID: ${env:GMAIL_CLIENT_ID, ''}
    GMAIL_CLIENT_SECRET: ${env:GMAIL_CLIENT_SECRET, ''}
    GMAIL_REFRESH_TOKEN: ${env:GMAIL_REFRESH_TOKEN, ''}
    # Polling configuration
    MAX_RESULTS: ${env:MAX_RESULTS, '5'}
    POLL_INTERVAL: ${env:POLL_INTERVAL, '5000'}  # Milliseconds between polls (default: 10 seconds)
    # Optional: Set SENDER_EMAIL to filter by sender, leave empty to process all unread emails
    SENDER_EMAIL: ${env:SENDER_EMAIL, 'anil.kashipaka@applaudhr.com'}

functions:
  gmailPoller:
    handler: dist/gmail-oauth/poller-lambda.handler
    reservedConcurrency: 1  # Prevent overlapping executions when scheduled frequently
    events:
      # Schedule to restart every 14 minutes (avoids overlap while keeping continuous polling)
      - schedule:
          rate: rate(14 minutes)
          enabled: true
          description: Restart Gmail poller every 14 minutes for continuous polling without duplicates
    # Optional: Also expose as HTTP endpoint for manual testing
    # events:
    #   - http:
    #       path: gmail/poll
    #       method: get
    #       cors: true

plugins:
  - serverless-plugin-typescript

custom:
  serverlessPluginTypescript:
    tsConfigFileLocation: './tsconfig.json'

